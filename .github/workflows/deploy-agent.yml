name: Deploy LLM Agent to Cloud Run

on:
  push:
    branches:
      - main
      - testing-model-ci-cd

env:
  PROJECT_ID: homiehub
  SERVICE_NAME: homiehub-llm-agent-api
  REGION: us-east4

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # -----------------------------
    # Write secrets inside the build folder
    # -----------------------------
    - name: Set up GCP key
      run: |
        echo '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > model-pipeline/llm-agent/GCP_Account_Key.json

    - name: Set up .env
      run: |
        echo "${{ secrets.ENV_FILE }}" > model-pipeline/llm-agent/.env

    # -----------------------------
    # Authenticate and set up gcloud
    # -----------------------------
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for GCR
      run: gcloud auth configure-docker

    # -----------------------------
    # Build and push Docker image
    # -----------------------------
    - name: Build Docker image (LLM Agent)
      working-directory: model-pipeline/llm-agent
      run: |
        docker build -t gcr.io/homiehub/homiehub-llm-agent-api:${{ github.sha }} .
        docker tag gcr.io/homiehub/homiehub-llm-agent-api:${{ github.sha }} gcr.io/homiehub/homiehub-llm-agent-api:latest

    - name: Push Docker image to GCR
      working-directory: model-pipeline/llm-agent
      run: |
        docker push gcr.io/homiehub/homiehub-llm-agent-api:${{ github.sha }}
        docker push gcr.io/homiehub/homiehub-llm-agent-api:latest

    # -----------------------------
    # Deploy to Cloud Run
    # -----------------------------
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy homiehub-llm-agent-api \
          --image gcr.io/homiehub/homiehub-llm-agent-api:${{ github.sha }} \
          --region $REGION \
          --platform managed \
          --allow-unauthenticated \
          --port 8080 \
          --memory 2Gi \
          --cpu 2 \
          --timeout 300

    # -----------------------------
    # Clean up secrets
    # -----------------------------
    - name: Cleanup sensitive files
      if: always()
      run: |
        rm -f model-pipeline/llm-agent/GCP_Account_Key.json
        rm -f model-pipeline/llm-agent/.env

    # -----------------------------
    # Send Email Notifications
    # -----------------------------
    - name: Send Email on Success
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USER }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        from: "samhita.kolluri@gmail.com"
        subject: "LLM Agent Deployment Successful ✅"
        body: "LLM Agent has been deployed to Cloud Run successfully.\nService URL: https://homiehub-llm-agent-api-$REGION.a.run.app"
        to: "samhita.kolluri@gmail.com"

    - name: Send Email on Failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USER }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        from: "samhita.kolluri@gmail.com"
        subject: "LLM Agent Deployment Failed ❌"
        body: "LLM Agent deployment to Cloud Run failed. Check the GitHub Actions logs for details."
        to: "samhita.kolluri@gmail.com"
